<!doctype html>
<html class="no-js">
	<head>
		<meta charset="utf-8">
		<title>Clear CloudFlare Cache from VSTS — AKJ.IO</title>
		<meta name="description" content="A website from Allan Kimmer Jensen, mostly about being awesome. Granted there are posts about web development.">
		<meta name="viewport" content="width=device-width, initial-scale=1">

		

		<link href='https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic' rel='stylesheet' type='text/css'>

		<!-- build:css /styles/main.css -->
		<!-- bower:css -->
		<!-- endbower -->
		<link rel="stylesheet" href="/styles/main.css">

		<!-- endbuild -->

		<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/default.min.css">

		<!-- build:js /scripts/vendor/modernizr.js -->
		<!-- endbuild -->
	</head>
	<body>
		<header class="header">
			<nav class="container">
				<h3>AKJ.IO<span class="by">Allan Kimmer Jensen</span></h3>
				<ul class="menu">
					<li class="menu__item menu__item--active">
						<a class="menu__item__link" href="/">Blog <span class="menu__item__link__description">Internet Adventures</span></a>
					</li>
					<li class="menu__item">
						<a class="menu__item__link" href="/about-me/">About Me <span class="menu__item__link__description">Stats, Level and Skills!</span></a>
					</li>
					<li class="menu__item">
						<a class="menu__item__link" href="/labs/">Labs <span class="menu__item__link__description">Insane Experiments</span></a>
					</li>
				</ul>
			</nav>
		</header>
		
		
		<main>
			
	<article class="article">
		
		<div class="article__content">
			<header class="article__header">
				<h1 itemprop="headline">Clear CloudFlare Cache from VSTS</h1>
				<h3>Cache everything and purge it when releasing a new version from Visual Studio Team Services</h3>
				<div class="article__header__metadata">
					<time itemprop="datePublished" datetime="12 April 2017"><span class="glyphicon glyphicon-time" aria-hidden="true"></span>12 April 2017</time>
				</div>
			</header>

			<p>Recently I created a website for a client, it was a static generated website, a promosite with only one page.</p>
<p>This gave me some nice opportunities for trying out some nice things. It&#39;s all generated with <a href="https://gulpjs.com">gulp</a>, much like this site - however it&#39;s optimized to be a single page.</p>
<p>It&#39;s code is in <abbr title="Visual Studio Team Services">VSTS</abbr>, and I set it up to build whenever we create a Pull Request.
This works very well, and in one week we did around 140 pull requests - with code reviews.</p>
<p>I found a bug that made it impossible to run Gulp 4 with the Gulp task, and created an <a href="https://github.com/Microsoft/vsts-tasks/issues/3890">issue</a> on the bugtracker. To get around this I created a PowerShell that invokes the local gulp, and that fixed everything.</p>
<p>Releasing the site was done with <abbr title="Visual Studio Team Services">VSTS</abbr> as well. A small note to take here is due to everything being HTML, it&#39;s set to be cached on Cloudflare for the best performance - to clear this cache, you need to login to cloudflare and press a button or use their API.</p>
<p>I like automated things and created this script:</p>
<pre><code class="lang-powershell">$AUTH_USER = &#39;&#39;
$AUTH_TOKEN = &#39;&#39;
$ZONE_KEY = &#39;&#39;

$Headers = @{
    &#39;X-Auth-Key&#39;=$AUTH_TOKEN;
    &#39;X-Auth-Email&#39;=$AUTH_USER;
    &#39;Content-Type&#39;=&#39;application/json&#39;
}
$Body = @{
    &#39;purge_everything&#39;=[boolean]&#39;True&#39;
} | ConvertTo-Json

Invoke-RestMethod https://api.cloudflare.com/client/v4/zones/$ZONE_KEY/purge_cache -Method DELETE -Headers $Headers -Body $Body -ContentType &#39;application/json&#39;
</code></pre>
<p>On the <a href="https://api.cloudflare.com/">Cloudflare documentation</a> there is an example using curl, but it all being windows I rewrote that in powershell, and it works just great.</p>
<p>This script clears everything, I could have extended it, to clear only the changed files from the release, but this seemed like overkill - taking everything into account.</p>


			<footer class="article__footer">
				<a itemprop="discussionUrl" href="#">Show comments...</a>
<div id="disqus_thread"></div>
<script type="text/javascript">
	var showComments = document.querySelector('[itemprop="discussionUrl"]');

	showComments.addEventListener('click', function(e) {
		e.preventDefault();
		/* * * CONFIGURATION VARIABLES * * */
	    var disqus_shortname = 'akj';

	    /* * * DON'T EDIT BELOW THIS LINE * * */
	    (function() {
	        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
	        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	    })();
	});
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

			</footer>
		</div>
	</article>

			<div class="footer">
				<p>© 2017 Allan Kimmer Jensen</p>
			</div>

			
		</main>

		<!-- Google Analytics: change UA-XXXXX-X to be your site's ID. -->
		<script>
			(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
			function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
			e=o.createElement(i);r=o.getElementsByTagName(i)[0];
			e.src='//www.google-analytics.com/analytics.js';
			r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
			ga('create','UA-16106069-1');ga('send','pageview');
		</script>

		<!-- build:js /scripts/vendor.js -->
		<!-- bower:js -->
		<!-- endbower -->
		<!-- endbuild -->

		<!-- build:js /scripts/main.js -->
		<!-- <script src="/scripts/main.js"></script> -->
		<!-- endbuild -->

		<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
		<script>hljs.initHighlightingOnLoad();</script>
	</body>
</html>
